<!-- Page Header -->
<div class="flex items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-green-100 sticky top-0 z-40">
  <!-- Back Button -->
  <button *ngIf="currentPage === 'detail'" (click)="goBackToList()"
    class="w-10 h-10 rounded-xl bg-green-100 flex items-center justify-center hover:bg-green-200 transition-colors">
    <i class="ri-arrow-left-line text-green-700"></i>
  </button>

  <!-- Icon -->
  <div
    class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-green-100 flex items-center justify-center shadow-inner flex-shrink-0">
    <img *ngIf="selectedAnimal?.animalImage" [src]="selectedAnimal.animalImage" alt="Animal"
      class="w-full h-full object-cover" />

    <img *ngIf="!selectedAnimal?.animalImage" src="assets/DairryFarmImg/AniHistory.png" alt="Animal Health History"
      class="w-7 h-7 object-contain" />
  </div>

  <!-- Title -->
  <div class="min-w-0">
    <h1 class="text-xl sm:text-2xl font-semibold text-green-900 truncate">
      <ng-container *ngIf="currentPage === 'list'">Animal Health History</ng-container>
      <ng-container *ngIf="currentPage === 'detail'">
        {{ selectedAnimal?.animalName }} - Health History
      </ng-container>
    </h1>

    <p class="text-xs sm:text-sm text-green-600 -mt-0.5 truncate">
      <ng-container *ngIf="currentPage === 'list'">Select animal to view history</ng-container>
      <ng-container *ngIf="currentPage === 'detail'">
        {{ totalHealthRecords }} records | Total: {{ formatPrice(totalExpenses) }}
      </ng-container>
    </p>
  </div>
</div>

<main class="min-h-screen bg-green-50 p-3 sm:p-4 md:p-6">
  <div class="max-w-7xl mx-auto space-y-4 sm:space-y-6">

    <!-- ================= ANIMAL LIST ================= -->
    <ng-container *ngIf="currentPage === 'list'">

      <!-- Search -->
      <div class="bg-white rounded-xl shadow-sm p-3 sm:p-4">
        <div class="relative">
          <input type="text" [(ngModel)]="searchTerm" (ngModelChange)="onSearch()"
            placeholder="Search animals by name..." class="block w-full rounded-md border border-green-200 bg-white text-green-800 placeholder-green-400
                   py-2 pl-10 pr-3 text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-green-200">
          <span class="absolute left-3 top-1/2 -translate-y-1/2 text-green-400">
            <i class="ri-search-2-fill"></i>
          </span>
        </div>
      </div>

      <!-- Loading -->
      <div *ngIf="isLoading" class="text-center py-8">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div>
        <p class="text-sm text-green-600 mt-2">Loading animals...</p>
      </div>

      <!-- Animal Cards -->
      <div *ngIf="!isLoading">
        <div *ngIf="filteredAnimals.length > 0; else noAnimals"
          class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">

          <div *ngFor="let animal of filteredAnimals" (click)="viewAnimalHistory(animal)"
            class="bg-white border border-green-100 rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow cursor-pointer">

            <div class="flex items-center gap-3 mb-3">
              <div class="w-12 h-12 rounded-lg overflow-hidden bg-green-50 border flex items-center justify-center">
                <img *ngIf="animal.animalImage" [src]="animal.animalImage" class="w-full h-full object-cover" />
                <img *ngIf="!animal.animalImage" src="../../../assets/DairryFarmImg/AniHistory.png"
                  class="w-7 h-7 object-contain" />
              </div>

              <div class="min-w-0">
                <h3 class="font-medium text-green-900 truncate">{{ animal.animalName }}</h3>
                <p class="text-xs text-green-600">Health Records</p>
              </div>
            </div>

            <div class="flex justify-between text-sm">
              <span class="text-green-700">Records</span>
              <span class="font-semibold text-green-900">{{ animal.totalHealthRecords || 0 }}</span>
            </div>

            <div class="flex justify-between text-sm mt-1">
              <span class="text-green-700">Total Expense</span>
              <span class="font-semibold text-green-900">{{ formatPrice(animal.totalExpenses) }}</span>
            </div>

          </div>
        </div>

        <ng-template #noAnimals>
          <div class="text-center py-12 bg-white rounded-xl border border-green-100">
            <h3 class="text-lg font-medium text-green-900 mb-2">No Animals Found</h3>
            <p class="text-sm text-green-600">Add animals to view health history.</p>
          </div>
        </ng-template>
      </div>

    </ng-container>

    <!-- ================= DETAIL HISTORY ================= -->
    <ng-container *ngIf="currentPage === 'detail'">

      <!-- Search -->
      <div class="bg-white rounded-xl shadow-sm p-3 sm:p-4">
        <div class="relative">
          <input type="text" placeholder="Search health records..." class="block w-full rounded-md border border-green-200 bg-white text-green-800 placeholder-green-400
                   py-2 pl-10 pr-3 text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-green-200">
          <span class="absolute left-3 top-1/2 -translate-y-1/2 text-green-400">
            <i class="ri-search-2-fill"></i>
          </span>
        </div>
      </div>

      <!-- Loading -->
      <div *ngIf="isLoadingHistory" class="text-center py-8">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div>
        <p class="text-sm text-green-600 mt-2">Loading health history...</p>
      </div>

      <!-- Grouped History -->
      <div *ngIf="!isLoadingHistory">

        <div *ngIf="healthHistory.length > 0; else noHistory" class="space-y-6">

          <div *ngFor="let group of groupedHistory | keyvalue">

            <!-- Date Header -->
            <div class="sticky top-16 z-20 bg-green-50 py-2 mb-3 border-b border-green-200">
              <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full bg-green-500"></div>
                <h3 class="text-lg font-semibold text-green-900">{{ group.key }}</h3>
                <span class="text-sm text-green-600">({{ group.value.length }})</span>
              </div>
            </div>

            <!-- Records -->
            <div class="space-y-2 ml-3 border-l border-green-200 pl-4">
              <div *ngFor="let record of group.value" class="bg-white border border-green-100 rounded-lg p-3 shadow-sm">

                <div class="flex justify-between items-start">

                  <div class="min-w-0">
                    <span
                      class="inline-flex items-center text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full mb-1">
                      {{ record.recordType }}
                    </span>

                    <h4 class="text-sm font-medium text-green-900 truncate">{{ record.reason }}</h4>

                    <p class="text-xs text-green-700 mt-1">
                      <i class="ri-calendar-line mr-1"></i>
                      {{ record.formattedDate || formatDate(record.recordDate) }}
                    </p>
                  </div>

                  <div class="text-green-600 font-bold text-sm">
                    â‚¹{{ record.price }}
                  </div>

                </div>

              </div>
            </div>

          </div>
        </div>

        <ng-template #noHistory>
          <div class="text-center py-12 bg-white rounded-xl border border-green-100">
            <h3 class="text-lg font-medium text-green-900 mb-2">No Health Records</h3>
            <p class="text-sm text-green-600 mb-4">
              No records found for {{ selectedAnimal?.animalName }}
            </p>
            <button (click)="goBackToList()"
              class="px-4 py-2 bg-green-100 text-green-800 rounded-lg hover:bg-green-200">
              Back to Animals
            </button>
          </div>
        </ng-template>

      </div>

    </ng-container>

  </div>
</main>